<!DOCTYPE html>
<html>
<head>
    <title>Test Frontend Fix</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>Frontend Authentication Fix Test</h1>
    
    <div id="status"></div>
    
    <h2>Actions:</h2>
    <button onclick="clearStorage()">Clear All Storage</button>
    <button onclick="setCorrectAuth()">Set Correct Auth Data</button>
    <button onclick="testLogin()">Test Login API</button>
    <button onclick="testEventsAPI()">Test Events API</button>
    <button onclick="checkCurrentAuth()">Check Current Auth</button>
    
    <h2>Results:</h2>
    <div id="results"></div>
    
    <script>
        const API_BASE = 'http://127.0.0.1:8000';
        
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }
        
        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            log('All storage cleared', 'success');
        }
        
        function setCorrectAuth() {
            const userData = {
                id: 2,
                username: 'saiku',
                email: 'saikushith@alstonair.com',
                first_name: 'saiku',
                last_name: '',
                user_type: 'customer'
            };
            
            localStorage.setItem('partyoria_user', JSON.stringify(userData));
            log('Correct user data set in localStorage', 'success');
        }
        
        async function testLogin() {
            try {
                log('Testing login API...', 'info');
                const response = await fetch(`${API_BASE}/api/auth/login/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'saiku', password: 'saiku123' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    localStorage.setItem('partyoria_user', JSON.stringify(data.user));
                    log('Login successful! Tokens saved.', 'success');
                } else {
                    const error = await response.text();
                    log(`Login failed: ${error}`, 'error');
                }
            } catch (e) {
                log(`Login error: ${e.message}`, 'error');
            }
        }
        
        async function testEventsAPI() {
            try {
                log('Testing events API...', 'info');
                const token = localStorage.getItem('access_token');
                
                const headers = { 'Content-Type': 'application/json' };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                    log('Using auth token for request', 'info');
                } else {
                    log('No auth token found', 'error');
                }
                
                const response = await fetch(`${API_BASE}/api/events/`, { headers });
                
                if (response.ok) {
                    const events = await response.json();
                    log(`Events API success! Found ${events.length} events`, 'success');
                } else {
                    log(`Events API failed: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (e) {
                log(`Events API error: ${e.message}`, 'error');
            }
        }
        
        function checkCurrentAuth() {
            const user = localStorage.getItem('partyoria_user');
            const token = localStorage.getItem('access_token');
            const authStorage = localStorage.getItem('auth-storage');
            
            log('=== Current Auth Status ===', 'info');
            log(`User data: ${user ? 'Present' : 'Missing'}`, user ? 'success' : 'error');
            log(`Access token: ${token ? 'Present' : 'Missing'}`, token ? 'success' : 'error');
            log(`Auth storage: ${authStorage ? 'Present' : 'Missing'}`, authStorage ? 'success' : 'error');
            
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    log(`User ID: ${userData.id}, Username: ${userData.username}`, 'info');
                } catch (e) {
                    log('Failed to parse user data', 'error');
                }
            }
        }
        
        // Initial check
        checkCurrentAuth();
    </script>
</body>
</html>